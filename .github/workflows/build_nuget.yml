name: Build and Publish NuGet (OIDC)

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v0.1.0, v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ csproj ä¸­çš„ç‰ˆæœ¬ï¼‰'
        required: false
        type: string

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    permissions:
      id-token: write  # å¯ç”¨ GitHub OIDC tokenï¼Œç”¨äº Trusted Publishing
      contents: write  # å…è®¸åˆ›å»º GitHub Release

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: ğŸ”§ è®¾ç½® .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ“ æå–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬å·: $VERSION"
          elif [ "${{ github.event_name }}" == "push" ] && [ -n "${{ github.ref }}" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "ä» Git æ ‡ç­¾æå–ç‰ˆæœ¬å·: $VERSION"
          else
            VERSION=$(grep -oP '<Version>\K[^<]+' Arc.UniInk/Arc.UniInk/Arc.UniInk.csproj | head -1)
            echo "ä» csproj æ–‡ä»¶æå–ç‰ˆæœ¬å·: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·: $VERSION"

      - name: ğŸ”„ æ›´æ–° csproj ç‰ˆæœ¬å·
        if: steps.get_version.outputs.version != ''
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          sed -i "s|<Version>.*</Version>|<Version>$VERSION</Version>|g" Arc.UniInk/Arc.UniInk/Arc.UniInk.csproj
          echo "âœ… å·²æ›´æ–°ç‰ˆæœ¬å·åˆ° $VERSION"

      - name: ğŸ” è¿˜åŸä¾èµ–
        run: dotnet restore Arc.UniInk/Arc.UniInk.sln

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: dotnet build Arc.UniInk/Arc.UniInk.sln -c Release --no-restore

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
        run: |
          if [ -d "Arc.UniInk/Arc.UniInk.Tests" ]; then
            dotnet test Arc.UniInk/Arc.UniInk.sln -c Release --no-build --verbosity normal
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•é¡¹ç›®ï¼Œè·³è¿‡æµ‹è¯•"
          fi
        continue-on-error: true

      - name: ğŸ“¦ æ‰“åŒ… NuGet
        run: dotnet pack Arc.UniInk/Arc.UniInk/Arc.UniInk.csproj -c Release --no-build -o ./artifacts

      - name: ğŸ“‹ åˆ—å‡ºç”Ÿæˆçš„åŒ…
        run: |
          echo "ğŸ“¦ ç”Ÿæˆçš„ NuGet åŒ…:"
          ls -lh ./artifacts/

      - name: ğŸ” NuGet ç™»å½• (OIDC â†’ ä¸´æ—¶ API Key)
        uses: NuGet/login@v1
        id: nuget_login
        with:
          user: ${{ secrets.NUGET_USER }}  # æ‚¨çš„ nuget.org ç”¨æˆ·åï¼ˆprofile nameï¼‰

      - name: ğŸš€ å‘å¸ƒåˆ° NuGet.org
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key ${{ steps.nuget_login.outputs.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-${{ steps.get_version.outputs.version }}
          path: ./artifacts/*.nupkg
          retention-days: 90

      - name: ğŸ‰ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ./artifacts/*.nupkg
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "=========================================="
          echo "âœ… NuGet åŒ…å‘å¸ƒæˆåŠŸï¼"
          echo "=========================================="
          echo "ğŸ“¦ åŒ…åç§°: Arc.UniInk"
          echo "ğŸ·ï¸  ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}"
          echo "ğŸ”— NuGet é“¾æ¥: https://www.nuget.org/packages/Arc.UniInk/"
          echo ""
          echo "â³ åŒ…é€šå¸¸éœ€è¦ 5-15 åˆ†é’Ÿæ‰èƒ½åœ¨ NuGet.org ä¸Šå¯ç”¨"
          echo "=========================================="